= Permissions
:navtitle: Permissions

Almost every interaction with an OpenShift environment that you can think of
requires going through the OpenShift's control plane API. All API interactions are both authenticated (AuthN - who are you?) and authorized (AuthZ - are you allowed to do what you are asking?).

[NOTE]
====
什么是身份验证（authn）？ 身份验证意味着确保一个人或设备是他们声称的人（或什么人）。 领取活动门票的人可能会被要求出示身份证以验证身份； 类似地，应用程序或数据库可能希望通过检查用户的身份来确保用户的合法性。 身份验证确保数据不会暴露给错误的人。

什么是授权（authz）？ 授权决定了经过身份验证的用户可以看到和执行的操作。 想想当银行客户在线登录他们的帐户时会发生什么。 因为他们的身份已经过验证，他们可以看到自己的账户余额和交易历史——但他们无权查看其他人的。 相反，银行的经理可以被授权查看任何客户的财务数据。 同样，一个人可能是一家企业的合法员工，他们可能已经验证了自己的身份，但这并不意味着他们应该有权访问该企业的所有文件和数据。 例如，来自人力资源或会计部门以外的员工不应该能够看到每个人的薪酬。 用户的授权级别决定了他们有权做什么； 因此，授权操作的通用术语是“权限permissions”。 这个概念的另一个术语是“特权privileges”。
====

In the log aggregation lab we saw that there was an
error in reference to a *Service Account*.

As OpenShift is a declarative platform, some actions will be performed by the platform and not by the end user (when he or she issues a command). These actions are performed using a *Service Account* which is a special type of `user` that the platform will use internally.

OpenShift automatically creates a few special service accounts in every project.
The **default** service account is the one taking the responsibility of running the pods, and OpenShift uses and injects this service account into
every pod that is launched. By changing the permissions for that service
account, we can do interesting things.

You can view current permissions in the web console, go to the Topology view in the Developer Perspective, click the `parksmap` entry, go to the *Details* tab, and then click the *Namespace*. 

image::parksmap-permissions-namespace.png[Namespace]

Then, select *Role Bindings* tab and filter by *Namespace Role Binding* so see all permissions for selected project.

image::parksmap-permissions-membership.png[Membership]

[#grant_serviceaccount_view_permissions]
== Exercise: Grant Service Account View Permissions
The parksmap application wants to talk to the OpenShift API to learn about other
*Pods*, *Services*, and resources within the *Project*. You'll soon learn why!

The parksmap application runs as a *Service Account* in our project on the cluster: namely the `default` *Service Account*.  It is to this *Service Account* that we can grant the necessary `view``access that will allow it to query the API to see what resources are within the *Project*. This also has the added benefit of addressing the cause of the error message we witnessed previously in the logs.

Choose an approach represented by the following tabs to update the `default` *Service Account* in the `%PROJECT%` project

[tabs]
====
OpenShift Console::
+
--
. From the *Workloads -> Deployments* page, click on the *Namespace*, then *Role Bindings* and then the *Create Binding* button.
+
image::parksmap-permissions-membership-serviceaccount-list.png[Service account list]
+
. Select *view* for the Role Binding Name *%PROJECT%* for the Namespace, *view* for the Role Name, *Service Account* for the Subject, *%PROJECT%* for the Subject Namespace, and *default* for the Subject Name.
+
image::parksmap-permissions-membership-serviceaccount-edit.png[Service account edit]
+
. Once you're finished editing permissions, click on the *Create* button.  You should then be able to see it on the `Role Bindings` list for the `%PROJECT%` project`
+
image::parksmap-permissions-membership-serviceaccount-done.png[Service account changed]
--
`oc` Command Line::
+
--
[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc project %PROJECT%
----

Then use the `oc policy add-role-to-user` command to give the predefined `view` _role_ to the user:

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc policy add-role-to-user view -z default
----

.What does the `-z` flag do?
****
From the `-h` output on `oc policy`:

[source,bash]
----
-z, --serviceaccount=[]: service account in the current namespace to use as a user
----

The `-z` syntax is a special one that saves us from having to type out the
entire string, which, in this case, is
`system:serviceaccount:%PROJECT%:default`. It's a nifty shortcut.
****

NOTE: The `-z` flag will only work for service accounts in the *current* project.  If you're referring to a service account in a different project, use the `-n <project>`switch.
--
====

[#redeploy_application]
== Exercise: Redeploy Application

[.console-input]
[source,bash,subs="+attributes,macros+"]
----
oc rollout restart deployment/parksmap
----

A new deployment is immediately started. Return to Topology view and click the `parksmap` entry again to watch it happen. You might not be fast enough! But it will be reflected in the *ReplicaSet* number.

image::parksmap-permissions-redeployed.png[Application deployed]

If you look at the logs for the application now, you should see no errors.  That's great.
